{% extends 'layout/base.html' %}
{% load static %}
{% block context %}
<style>
.portlet{ margin-bottom: 2vh;}
    /* Popup background overlay */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: none; /* Hidden by default */
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

/* Popup box */
.popup-content {
  background: #fff;
  padding: 20px;
  width: 50%;
  max-width: 90%;
  border-radius: 10px;
  position: relative;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

/* Close button */
.close-btn {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 22px;
  cursor: pointer;
  color: #333;
}

/* Simple styling */
.btn {
  padding: 8px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-success {
  background: #28a745;
  color: white;
  margin-top: 10px;
}
</style>

<div style=" padding: 20px"> </div>
<div class="row">
    <div class="col-md-12" style="background-color: #eef1f5;">

        <!-- BEGIN PAGE TITLE-->
        <h3 class="page-title"> {{project_obj.name}}
            <small> | {{project_obj.category}} Project</small>
        </h3>
        <!-- END PAGE TITLE-->

        <div class="row">
            <div class="col-md-12">
                <!-- BEGIN PROFILE SIDEBAR -->
                <div class="profile-sidebar">
                    <!-- PORTLET MAIN -->
                    <div class="portlet light profile-sidebar-portlet " style="height: 34vh;">                            
                        <!-- SIDEBAR USER TITLE -->
                        <div class="profile-usertitle">
                            <div class="profile-userpic">
                                {% if project_obj.project_lead.passport_photo %}
                                    <img src="{{ project_obj.project_lead.passport_photo.url }}" alt="Profile Picture" class="img-responsive">
                                {% else %}
                                    <img src="{% static 'img/avatars/team1.jpg' %}" alt="Default Picture" class="img-responsive">
                                {% endif %}
                            </div>

                            <div class="profile-usertitle-name"> {{project_obj.project_lead.first_name}} {{project_obj.project_lead.last_name}} </div>
                            <div class="profile-usertitle-job"> Project lead </div>
                            <br>
                        </div>                           
                    </div>
                    <!-- END PORTLET MAIN -->
                    
                    <!-- PORTLET MAIN -->
                    <div class="portlet light " style="height: 34vh;">                            
                        <table class="table">
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="label label-sm label-warning">
                                            <i class="fa fa-pie-chart"></i>
                                        </div>
                                    </td>
                                    <td> Status </td>
                                    <td> {{project_obj.status}} </td>
                                </tr>

                                <tr>
                                    <td>
                                        <div class="label label-sm label-success">
                                            <i class="fa fa-asterisk"></i>
                                        </div>
                                    </td>
                                    <td> Priority </td>

                                    <td class="label-success label-sm" > {{project_obj.priority}} </td>
                                </tr>

                                <tr>
                                    <td>
                                        <div class="label label-sm label-primary">
                                            <i class="fa fa-map"></i>
                                        </div>
                                    </td>
                                    <td> Location </td>

                                    <td class="label-success label-sm" > {{project_obj.location}} </td>
                                </tr>

                                <tr>
                                    <td>
                                        <div class="label label-sm label-info">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                    </td>
                                    <td> Start Date </td>

                                    <td style="text-align: left;"> <small>{{project_obj.start_date}} </small> </td>
                                </tr>

                                <tr>
                                    <td>
                                        <div class="label label-sm label-danger">
                                            <i class="fa fa-calendar"></i> 
                                        </div>
                                    </td>
                                    <td> End Date </td> 
                                    <td style="text-align: left;"> <small>{{project_obj.end_date}}</small> </td>
                                </tr>

                                <tr style="border-bottom: 1px solid #FFF;">
                                    <td colspan="3">                                         
                                        <a class="btn btn-success" href="#" id="openPopupBtn" data-toggle="modal" data-target="#exampleModalCenter"> 
                                            <i class="fa fa-plus"></i> Project Stage
                                        </a>  
                                    </td> 
                                </tr>
                            </tbody>
                        </table>

                    </div>
                    <!-- END PORTLET MAIN -->

                    <!-- PORTLET MAIN -->
                    <div class="portlet light " style="height: 18vh;">                            
                        <table class="table">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fa fa-money"></i></th>
                                    <th colspan="2"> Project Costs </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>                                    
                                    <td colspan="2"> Budgeted Cost (Ksh.) </td>
                                    <td class="label-success label-sm" > {{project_obj.total_budgeted_cost}} </td>
                                </tr> 
                                <tr>                                    
                                    <td colspan="2"> Actual Cost (Ksh.) </td>
                                    <td class="label-success label-sm" > {{project_obj.total_actual_cost}} </td>
                                </tr>                                

                            </tbody>
                        </table>

                    </div>
                    <!-- END PORTLET MAIN -->

                    <!-- PORTLET MAIN -->
                    <div class="portlet light " style="height: 50vh;">                            
                        <div>
                            <h4 class="profile-desc-title">Project Description</h4>
                            <span class="profile-desc-text"> <small> {{project_obj.description}} </small> </span>                                
                        </div>
                    </div>
                    <!-- END PORTLET MAIN -->
                </div>
                <!-- END BEGIN PROFILE SIDEBAR -->
                <!-- BEGIN PROFILE CONTENT -->
                <div class="profile-content">
                    {% if stages %}
                        {% for stage in stages %}
                            <div class="row">
                                                        
                                <div class="col-md-6" style="margin-bottom: 2vh;">
                                    <!-- BEGIN PORTLET -->
                                    <div class="portlet light scroller" style="height: 70vh;">
                                        <div class="portlet-title">
                                            <div class="caption caption-md">
                                                <i class="icon-bar-chart theme-font hide"></i>
                                                <span class="caption-subject font-blue-madison bold uppercase">{{stage.name}}</span>
                                                <span class="caption-helper hide">information</span>
                                            </div>
                                            <!-- <div class="actions">
                                                <div class="btn-group btn-group-devided" data-toggle="buttons">
                                                    <label class="btn btn-transparent grey-salsa btn-circle btn-sm active">
                                                        <input type="radio" name="options" class="toggle" id="option1">Today</label>
                                                    <label class="btn btn-transparent grey-salsa btn-circle btn-sm">
                                                        <input type="radio" name="options" class="toggle" id="option2">Week</label>
                                                    <label class="btn btn-transparent grey-salsa btn-circle btn-sm">
                                                        <input type="radio" name="options" class="toggle" id="option2">Month</label>
                                                </div>
                                            </div> -->

                                        </div>
                                        <div class="portlet-body">
                                            <div class="row number-stats margin-bottom-30">
                                                <div class="col-md-6 col-sm-6 col-xs-6">
                                                    <div class="stat-left">
                                                        <div class="stat-chart">                                                            
                                                            <div id="sparkline_bar"></div>
                                                        </div>
                                                        <div class="stat-number">
                                                            <div class="title"> Total Budgeted Cost </div>
                                                            <div class="number"> Ksh. {{stage.total_budgeted_cost|floatformat:2}} </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 col-sm-6 col-xs-6">
                                                    <div class="stat-right">
                                                        <div class="stat-chart">                                                            
                                                            <div id="sparkline_bar2"></div>
                                                        </div>
                                                        <div class="stat-number">
                                                            <div class="title"> Total Actual Cost </div>
                                                            <div class="number"> Ksh. {{stage.total_actual_cost|floatformat:2}} </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="table-scrollable table-scrollable-borderless">
                                                <table class="table table-hover table-light">
                                                    <tbody>
                                                        <tr> 
                                                            <td> <b>Status</b> </td>
                                                            <td> {{stage.status}} </td>
                                                        </tr>
                                                        <tr> 
                                                            <td> <b>Priority</b> </td>
                                                            <td> {{stage.priority}} </td>
                                                        </tr>
                                                        <tr> 
                                                            <td> <b>Start Date</b> </td>
                                                            <td> {{stage.start_date}} </td>
                                                        </tr>
                                                        <tr> 
                                                            <td> <b>End Date</b> </td>
                                                            <td> {{stage.end_date}} </td>
                                                        </tr>
                                                        <tr> 
                                                            <td colspan="2"> <b>Description</b> </td>
                                                        </tr>
                                                        <tr> 
                                                            <td colspan="2"> {{stage.description}} </td>
                                                        </tr>
                                                    </tbody>                                                    
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- END PORTLET -->
                                </div>

                                <div class="col-md-6" style="margin-bottom: 2vh;">
                                    <!-- BEGIN PORTLET -->
                                    <div class="portlet light scroller" style="height: 70vh;">
                                        <div class="portlet-title tabbable-line">
                                            <div class="caption caption-md">
                                                <i class="icon-globe theme-font hide"></i>
                                                <span class="caption-subject font-blue-madison bold uppercase">Stage Activities</span>
                                            </div>
                                            <ul class="nav nav-tabs">
                                                <li >
                                                    <!-- <a href="#" class="btn" data-toggle="modal" data-target="#addActivityModal" data-stage-id="{{ stage.id }}"></a>
                                                        <i class="fa fa-plus"></i> Add Activity 
                                                    </a> -->
                                                    <a href="#" 
                                                        class="open-popup-btn" 
                                                        data-stage-id="{{ stage.id }}">
                                                        <i class="fa fa-plus"></i> Add Activity
                                                    </a>

                                                </li>                                                
                                            </ul>
                                        </div>
                                        <div class="portlet-body">
                                            <!--BEGIN TABS-->
                                            <div class="tab-content">
                                                <div class="tab-pane active" id="tab_1_1">
                                                    {% if stage.items.all %}  
                                                    <table class="table">
                                                        <thead class="table-dark">
                                                            <tr>
                                                                    <th> Activity</th>
                                                                    <th> Budgeted Cost</th>
                                                                    <th> Actual Cost</th>
                                                                    <th> Completed </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for item in stage.items.all %}
                                                                <tr>
                                                                    <td>{{item.name}}</td>
                                                                    <td>{{item.budgeted_cost}}</td>
                                                                    <td>{{item.actual_cost}}</td>
                                                                    {% if item.is_completed %}
                                                                        <td style="text-align: center; color: #198754;"><i class="fa fa-check success"></i></td>
                                                                    {% else %}
                                                                        <td style="text-align: center; color: #F00;"><i class="fa fa-times"></i></td>
                                                                    {% endif %}
                                                                </tr>
                                                                
                                                            {% endfor %}
                                                                <tr>
                                                                    <td> <b>Total Costs</b></td>
                                                                    <td><b>{{stage.total_budgeted_cost|floatformat:2}}</b></td>
                                                                    <td><b>{{stage.total_actual_cost|floatformat:2}}</b></td>
                                                                    <td></td>
                                                                </tr>
                                                        </tbody>
                                                      </table>                                                 
                                                       
                                                    {% endif %}
                                                    </div>
                                                </div>                                                
                                            </div>
                                            <!--END TABS-->
                                        </div>
                                    </div>
                                    <!-- END PORTLET -->
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}

                </div>
                <!-- END PROFILE CONTENT -->
            </div>
        </div>

        <!-- Modal -->
        <!-- Popup container (hidden by default) -->
        <div id="popupOverlay" class="popup-overlay">
            <div class="popup-content">
                <span id="closePopupBtn" class="close-btn">&times;</span>
                <br>
                <div class="col-md-12">
                    <div class="portlet box green">
                        <div class="portlet-title">
                            <div class="caption"> 
                                <i class="fa fa-plus"></i>
                                Create Project Stage 
                            </div>
                
                            <div class="tools">
                                <a style="color: #FFF;" href="javascript:;" class="collapse"> <i class="fa fa-compress"></i> </a>                
                            </div>
                        </div>
                        <div class="portlet-body form">
                            <!-- BEGIN FORM-->
                            <form action="{% url 'project:stages-create' %}" method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="row">
                
                                    {% if error_message %}
                                    <div class="col-md-12"><br><div class="alert alert-danger" role="alert">{{error_message}}</div></div>
                                    {% endif %}
                
                                    <div class="col-md-12">
                                        <div class="form-body">

                                            <input type="text" class="form-control" hidden value="{{project_obj.id}}" name="project_id"> 

                                            <div class="form-group"> 
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="control-label">Stage Name</label> <input type="text" class="form-control" placeholder="Stage Name" name="stage_name"> 
                                                    </div>
                
                                                    <div class="col-md-6">
                                                        <label class="control-label">Start Date</label> <input type="date" class="form-control" placeholder="Start Date" name="start_date"> 
                                                    </div>
                                                </div>
                                            </div>
                
                                            <div class="form-group"> 
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="control-label">Priority</label>
                                                        <select class="form-control" name="priority">
                                                            <option value="low">Low</option> 
                                                            <option value="high">High</option>
                                                            <option value="medium">Medium</option>
                                                            <option value="critical">Critical</option>
                                                        </select>                                        
                                                    </div>
                                                    
                                                    <div class="col-md-6">
                                                        <label class="control-label">End Date</label> <input type="date" class="form-control" placeholder="End Date" name="end_date"> 
                                                    </div>
                                                </div>
                                            </div>                                                           
                
                                            <div class="form-group"> 
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="control-label">Status</label>
                                                        <select class="form-control" name="status">
                                                            <option value="on_hold">On Hold</option> 
                                                            <option value="planned">Planned</option>
                                                            <option value="completed">Completed</option>
                                                            <option value="cancelled">Cancelled</option>
                                                            <option value="in_progress">In Progress</option>
                                                        </select>
                                                    </div>                
                
                                                </div>
                                            </div>                                            
                
                                            <div class="form-group"> 
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <label class="control-label">Description</label>
                                                        <textarea class="form-control" name="description" id="editor"></textarea>
                                                    </div>
                                                </div>
                                            </div>

                                            <hr>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-md-10">
                                                        Activities                                                        
                                                    </div>
                                                    <div class="col-md-2">
                                                        <a  href="#" id="addActivityBtn" data-toggle="modal" data-target="#exampleModalCenter"> 
                                                            <i class="fa fa-plus"></i> Add
                                                        </a>                                                         
                                                    </div>
                                                </div>

                                                <div id="activitiesContainer">
                                                    <!-- Dynamic activity rows will appear here -->
                                                </div>

                                            </div>
                
                                        </div>
                                    </div>
                
                                    <div class="col-md-12">
                                        <div class="form-body">
                                        <div class="form-actions">
                                            <button type="submit" class="btn green">Submit</button>
                                            <button type="button" class="btn default">Cancel</button>
                                        </div>
                                        </div>
                                    </div>
                                    
                                </div>
                               
                            </form>
                            <!-- END FORM-->
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Custom Popup Overlay -->
        <div id="activityPopup" class="popup-overlay">
            <div class="popup-content">                
                <div class="col-md-12">
                    <div class="portlet box red">
                        <div class="portlet-title">
                            <div class="caption"> 
                                <i class="fa fa-plus"></i>
                                Create New Activity 
                            </div>
                
                            <div class="tools">
                                <a style="color: #FFF;" href="javascript:;" class="collapse"> <i class="fa fa-compress"></i> </a>                
                            </div>
                        </div>
                        <div class="portlet-body form">
                            <!-- BEGIN FORM-->
                            <form action="{% url 'project:activity-create' %}" id="activityForm" method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="row">
                
                                    {% if error_message %}
                                    <div class="col-md-12"><br><div class="alert alert-danger" role="alert">{{error_message}}</div></div>
                                    {% endif %}
                                    
                                    <div class="col-md-12">
                                        <div class="form-body">

                                            <div class="form-group"> 
                                                <div class="row">
                                                    <input type="text" hidden id="popup-stage-id" name="stage_id">
                                                    <input type="text" class="form-control" hidden value="{{project_obj.id}}" name="main_project_id"> 

                                                    <div class="col-md-6">
                                                        <label class="control-label">Activity Name</label> <input type="text" class="form-control" placeholder="Activity Name" name="activity_name"> 
                                                    </div>
                
                                                    <div class="col-md-6">
                                                        <label class="control-label">Budgeted Cost (Ksh.)</label> <input type="number" step="0.01" class="form-control" name="budgeted_cost"> 
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group"> 
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="control-label">Completion Status </label>                                                        
                                                        <select class="form-control" name="is_completed">
                                                            <option value="0">No</option> 
                                                            <option value="1">Yes</option>
                                                        </select>
                                                    </div>
                
                                                    <div class="col-md-6">
                                                        <label class="control-label">Actual Cost (Ksh.)</label> <input type="number" step="0.01" class="form-control" name="actual_cost"> 
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>                                    
                
                                    <div class="col-md-12">
                                        <div class="form-body">
                                        <div class="form-actions">
                                            <button type="submit" class="btn green">Submit</button>
                                            <button type="button" id="cancelPopupBtn" class="btn default">Cancel</button>
                                        </div>
                                        </div>
                                    </div>
                                    
                                </div>
                               
                            </form>
                            <!-- END FORM-->
                        </div>
                    </div>
                </div>

            </div>            
        </div>
    </div>
</div>

<script>
    document.getElementById('addActivityBtn').addEventListener('click', function(e) {
        e.preventDefault();

        const container = document.getElementById('activitiesContainer');
        const index = container.children.length; // Number of existing activities

        const newRow = document.createElement('div');
        newRow.classList.add('activity-row');
        newRow.style.marginBottom = '10px';

        newRow.innerHTML = `
            <div class="row align-items-center" style="margin-bottom: 8px;">
                <div class="col-md-3">
                    <input type="text" class="form-control" name="activity_name_${index}" placeholder="Activity Name" required>
                </div>
                <div class="col-md-2">
                    <input type="number" step="0.01" class="form-control" name="budgeted_cost_${index}" placeholder="Budgeted Cost" required>
                </div>
                <div class="col-md-2">
                    <input type="number" step="0.01" class="form-control" name="actual_cost_${index}" placeholder="Actual Cost">
                </div>
                <div class="col-md-2 text-center">
                    <label>
                        <input type="checkbox" name="is_completed_${index}" value="true">
                        Completed
                    </label>
                </div>
                <div class="col-md-2 text-right">
                    <button type="button" class="btn btn-danger btn-sm remove-activity"><i class="fa fa-times"></i></button>
                </div>
            </div>
        `;

        container.appendChild(newRow);

        // Remove activity handler
        newRow.querySelector('.remove-activity').addEventListener('click', function() {
            newRow.remove();
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
      const popup = document.getElementById("activityPopup");
      const closeBtn = document.getElementById("closePopupBtn");
      const cancelBtn = document.getElementById("cancelPopupBtn");
      const openButtons = document.querySelectorAll(".open-popup-btn");
      const stageInput = document.getElementById("popup-stage-id");
    
      // When user clicks on "Add Activity" link
      openButtons.forEach(btn => {
        btn.addEventListener("click", function(e) {
          e.preventDefault();
          const stageId = this.getAttribute("data-stage-id");
          stageInput.value = stageId; // inject stage id into hidden input
          popup.style.display = "flex"; // show popup
        });
      });
    
      // Close popup when clicking the close or cancel buttons
      [closeBtn, cancelBtn].forEach(btn => {
        btn.addEventListener("click", function() {
          popup.style.display = "none";
        });
      });
    
      // Close popup when clicking outside the popup content
      window.addEventListener("click", function(e) {
        if (e.target === popup) {
          popup.style.display = "none";
        }
      });
    });
</script>
    

<script>
    // Open popup
    document.getElementById("openPopupBtn").onclick = function () {
      document.getElementById("popupOverlay").style.display = "flex";
    };
  
    // Close popup
    document.getElementById("closePopupBtn").onclick = function () {
      document.getElementById("popupOverlay").style.display = "none";
    };
  
    // Optional: close popup if you click outside content
    window.onclick = function (event) {
      const overlay = document.getElementById("popupOverlay");
      if (event.target === overlay) {
        overlay.style.display = "none";
      }
    };
  </script>
    
{% endblock %}